pipeline {

    agent any
    // agent {
    //     label 'changiapp-macos'
    // }

    environment {
        // Project specific variables
        PROJID = 'changiapp-fe-android'
        DEV = 'DEV'
        SIT = 'SIT'
        UAT = 'UAT'
        PRD = 'PROD'
        BRANCH = 'sit'
        ENV_BRANCH  = "${appenv}"
        REL_VERSION = "${rversion}"

        REDEPLOY_FROM_ERROR_FLAG = 'Deployment Failed'
        REDEPLOY_ARTIFACT_FLAG = 'Redeploy'
        JIRA_TRANSTATUS = "${transtatus}"

        //For Release to UAT and PROD
        GIT_URL = 'git@github.com:lephat08/jenkins-k8s.git'
        CRED_ID = 'DIVA-BITBUCKET-SSH-ACCESS'

    }

    stages {

        stage('Setup Parameters') {
            steps {
                script {

                    properties([
                        parameters([
                            choice(
                                choices: ['main','dev'], 
                                description: 'Application Branch', 
                                name: 'APPENV'
                            )
                        ])
                    ])

                    git branch: "${APPENV}", credentialsId: "${CRED_ID}", url: "${GIT_URL}"



                }
            }
        }


    }

    post {
        success {
            script {
                if ("${ENV_BRANCH}" == "${APPENV}") {
                    withEnv(["JIRA_SITE=${JIRA_DIVA}"]) {

                        // transition ID - 'Code Merge Successful' (SIT Deployment In-progress) -> 'CI/CD Successful' (Deployed in SIT) = 291
                        // transition ID - 'Code Merge Successful' (UAT Deployment In-progress) -> 'CI/CD Successful' (Deployed in UAT) = 191
                        // transition ID - 'Code Merge Successful' (PROD Deployment In-progress) -> 'CI/CD Successful' (Deployed in PROD) = 81
                        def id = '0'

                        if ("${ENV_BRANCH}" == "${PRD}") {    
                            id = '81' 
                        } else if("${ENV_BRANCH}" == "${UAT}") {
                            id = '191'
                        } else if("${ENV_BRANCH}" == "${UAT}") {
                            id = '291'
                        }

                        def transitionInput =
                            [
                                transition: [
                                    id: "${id}"
                                ]
                            ]

                        jiraTransitionIssue idOrKey: "${ISSUE_KEY}", input: transitionInput
                        jiraAddComment comment: "Build ${BUILD_NUMBER}: Deployment succeeded in ${ENV_BRANCH}.", idOrKey: "${ISSUE_KEY}"
                    }  
                }     
            }
        }

        failure {
            script {
                if ("${ENV_BRANCH}" == "${APPENV}") {
                    withEnv(["JIRA_SITE=${JIRA_DIVA}"]) {
                        
                        def transitions = jiraGetIssueTransitions idOrKey: "${ISSUE_KEY}"
                        echo transitions.data.toString()

                        if (transitions.data.toString() =~ /.*id:91, name:Closed.*/) {

                            //  transition ID - CI/CD Failed to Closed
                            def transitionInput =
                                [
                                    transition: [
                                        id: "91"
                                    ]
                                ]
                                
                            jiraTransitionIssue idOrKey: "${ISSUE_KEY}", input: transitionInput
                            jiraAddComment comment: "Build ${BUILD_NUMBER}: Deployment failed in ${ENV_BRANCH}, Click on \"Build URL\" below to check the error.", idOrKey: "${ISSUE_KEY}"
                        }
                    } 
                }      
            }
        }

        unstable {
            script {
                if ("${ENV_BRANCH}" == "${APPENV}") {
                    currentBuild.description = "${currentBuild.description} [W] Security/Quality Gate Violations\nPlease Check SONARQUBE/NEXUS IQ/FORTIFY\n"
                }
            }
        }

        always {
            echo "Clean up workspace!!!!!!!!!!!!!!!"
            //deleteDir()
        }
    }

}