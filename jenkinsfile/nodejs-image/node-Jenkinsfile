pipeline {

    agent any
    // agent {
    //     label 'changiapp-macos'
    // }

    environment {
        // Project specific variables
        PROJID = 'changiapp-fe-android'
        DEV = 'DEV'
        SIT = 'SIT'
        UAT = 'UAT'
        PRD = 'PROD'
        BRANCH = 'sit'
        ENV_BRANCH  = "${appenv}"
        REL_VERSION = "${rversion}"

        REDEPLOY_FROM_ERROR_FLAG = 'Deployment Failed'
        REDEPLOY_ARTIFACT_FLAG = 'Redeploy'
        JIRA_TRANSTATUS = "${transtatus}"

        //For Release to UAT and PROD
        GIT_URL = 'https://github.com/lephat08/jenkins-k8s.git'
        CRED_ID = 'DIVA-BITBUCKET-SSH-ACCESS'

    }

    stages {

        stage('Setup Parameters') {
            steps {
                script {

                    properties([
                        parameters([
                            choice(
                                choices: ['main','dev'], 
                                description: 'Application Branch', 
                                name: 'APPENV'
                            )
                        ])
                    ])

                    git branch: "${APPENV}",url: "${GIT_URL}"

                }
            }
        }

    }

    post {
        success {
            script {
                if ("${ENV_BRANCH}" == "${APPENV}") {
                    currentBuild.description = "${currentBuild.description} Build ${BUILD_NUMBER}: Deployment succeeded in ${ENV_BRANCH}.", idOrKey: "${ISSUE_KEY}\n"  
                }     
            }
        }

        failure {
            script {
                if ("${ENV_BRANCH}" == "${APPENV}") {
                    currentBuild.description = "${currentBuild.description} Build ${BUILD_NUMBER}: Deployment failed in ${ENV_BRANCH}, Click on \"Build URL\" below to check the error.", idOrKey: "${ISSUE_KEY}\n"
                }      
            }
        }

        unstable {
            script {
                if ("${ENV_BRANCH}" == "${APPENV}") {
                    currentBuild.description = "${currentBuild.description} [W] Security/Quality Gate Violations\nPlease Check SONARQUBE/NEXUS IQ/FORTIFY\n"
                }
            }
        }

        always {
            echo "Clean up workspace!!!!!!!!!!!!!!!"
            //deleteDir()
        }
    }

}